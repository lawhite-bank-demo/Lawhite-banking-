<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Panel</title>

<style>
body{
  font-family: Arial;
  background:#0b1e35;
  color:white;
  text-align:center;
}
.card{
  background:#102a46;
  padding:20px;
  border-radius:12px;
  margin:20px;
}
input,button,select{
  width:90%;
  padding:12px;
  margin-top:10px;
  border-radius:8px;
  border:none;
}
button{
  background:#2ecc71;
  color:white;
  font-size:16px;
}
.msg{
  margin-top:10px;
  color:#2ecc71;
}
</style>
</head>
<body>

<h2>Admin Panel</h2>

<!-- CREATE USER -->
<div class="card">
  <h3>Create User</h3>
  <input id="newUser" placeholder="Username">
  <input id="newPin" placeholder="PIN">
  <input id="newBalance" placeholder="Starting Balance">
  <select id="newCurrency">
    <option value="EUR">EUR</option>
    <option value="USD">USD</option>
    <option value="GBP">GBP</option>
  </select>
  <button onclick="createUser()">Create User</button>
</div>

<!-- ADD MONEY -->
<div class="card">
  <h3>Add Money</h3>
  <input id="targetUser" placeholder="Username">
  <input id="amount" placeholder="Amount">
  <button onclick="addMoney()">Credit Account</button>
</div>

<!-- DEDUCT MONEY -->
<div class="card">
  <h3>Deduct Money</h3>
  <input id="deductUser" placeholder="Username">
  <input id="deductAmount" placeholder="Amount">
  <button onclick="deductMoney()">Debit Account</button>
</div>

<!-- TRANSFER MONEY -->
<div class="card">
  <h3>Transfer Between Users</h3>
  <input id="fromUser" placeholder="From Username">
  <input id="toUser" placeholder="To Username">
  <input id="transferAmount" placeholder="Amount">
  <button onclick="transferMoney()">Transfer</button>
</div>

<div class="msg" id="msg"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBDp6wmJMY8WPyKPNE-bvVSiz4AIUbn71U",
  authDomain: "dechase-bank.firebaseapp.com",
  projectId: "dechase-bank",
  storageBucket: "dechase-bank.appspot.com",
  messagingSenderId: "44428081485",
  appId: "1:44428081485:web:85d993a939d380336e1f04"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function createUser(){
  const username = newUser.value.trim();
  const pin = newPin.value.trim();
  const balance = Number(newBalance.value) || 0;
  const currency = newCurrency.value;

  if(!username || !pin){
    alert("Enter username and PIN");
    return;
  }

  db.collection("users").doc(username).set({
    username,
    pin,
    balance,
    currency,
    role: "user",
    transactions: []
  });

  msg.innerText = "✅ User created";
}

function addMoney(){
  const username = targetUser.value.trim();
  const amount = Number(document.getElementById("amount").value);

  if(!username || !amount){
    alert("Enter username & amount");
    return;
  }

  const ref = db.collection("users").doc(username);

  db.runTransaction(async (transaction) => {
    const doc = await transaction.get(ref);

    if(!doc.exists){
      alert("User not found");
      return;
    }

    const newBalance = (doc.data().balance || 0) + amount;

    transaction.update(ref, {
      balance: newBalance,
      transactions: firebase.firestore.FieldValue.arrayUnion({
        amount: amount,
        note: "Admin credit",
        date: new Date().toLocaleString()
      })
    });
  });

  msg.innerText = "✅ Money added";
}

function deductMoney(){
  const username = deductUser.value.trim();
  const amount = Number(document.getElementById("deductAmount").value);

  if(!username || !amount){
    alert("Enter username & amount");
    return;
  }

  const ref = db.collection("users").doc(username);

  db.runTransaction(async (transaction) => {
    const doc = await transaction.get(ref);

    if(!doc.exists){
      alert("User not found");
      return;
    }

    const balance = doc.data().balance || 0;

    if(balance < amount){
      alert("Insufficient balance");
      return;
    }

    transaction.update(ref, {
      balance: balance - amount,
      transactions: firebase.firestore.FieldValue.arrayUnion({
        amount: -amount,
        note: "Admin debit",
        date: new Date().toLocaleString()
      })
    });
  });

  msg.innerText = "✅ Money deducted";
}

function transferMoney(){

  const fromUser = fromUser.value.trim();
  const toUser = toUser.value.trim();
  const amount = Number(document.getElementById("transferAmount").value);

  if(!fromUser || !toUser || !amount){
    alert("Enter all transfer details");
    return;
  }

  if(fromUser === toUser){
    alert("Cannot transfer to same account");
    return;
  }

  const fromRef = db.collection("users").doc(fromUser);
  const toRef = db.collection("users").doc(toUser);

  db.runTransaction(async (transaction) => {

    const fromDoc = await transaction.get(fromRef);
    const toDoc = await transaction.get(toRef);

    if(!fromDoc.exists || !toDoc.exists){
      alert("User not found");
      return;
    }

    const fromBalance = fromDoc.data().balance || 0;

    if(fromBalance < amount){
      alert("Insufficient funds");
      return;
    }

    const toBalance = toDoc.data().balance || 0;

    transaction.update(fromRef, {
      balance: fromBalance - amount,
      transactions: firebase.firestore.FieldValue.arrayUnion({
        amount: -amount,
        note: "Transfer to " + toUser,
        date: new Date().toLocaleString()
      })
    });

    transaction.update(toRef, {
      balance: toBalance + amount,
      transactions: firebase.firestore.FieldValue.arrayUnion({
        amount: amount,
        note: "Transfer from " + fromUser,
        date: new Date().toLocaleString()
      })
    });

  });

  msg.innerText = "✅ Transfer successful";
}
</script>

</body>
</html>