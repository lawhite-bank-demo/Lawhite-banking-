<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Panel</title>

<style>
body{
  font-family: Arial;
  background:#0b1e35;
  color:white;
  text-align:center;
}
.card{
  background:#102a46;
  padding:20px;
  border-radius:12px;
  margin:20px;
}
input,button{
  width:90%;
  padding:12px;
  margin-top:10px;
  border-radius:8px;
  border:none;
}
button{
  background:#2ecc71;
  color:white;
  font-size:16px;
}
.msg{
  margin-top:10px;
  color:#2ecc71;
}
.result{
  margin-top:10px;
  background:#0b1e35;
  padding:10px;
  border-radius:8px;
}
</style>
</head>
<body>

<h2>ðŸ‘‘ Admin Panel</h2>

<!-- LOGIN -->
<div class="card" id="loginCard">
  <h3>Admin Login</h3>
  <input id="adminUser" placeholder="Admin Username">
  <input id="adminPin" placeholder="Admin PIN">
  <button onclick="adminLogin()">Login</button>
</div>

<div id="panel" style="display:none">

<!-- CREATE USER -->
<div class="card">
  <h3>Create User</h3>
  <input id="newUser" placeholder="Username">
  <input id="newPin" placeholder="PIN">
  <input id="newBalance" placeholder="Starting Balance">
  <button onclick="createUser()">Create User</button>
</div>

<!-- CREDIT -->
<div class="card">
  <h3>Add Money</h3>
  <input id="creditUser" placeholder="Username or Account #">
  <input id="creditAmount" placeholder="Amount">
  <input id="creditDate" placeholder="Date (optional)">
  <button onclick="addMoney()">Credit</button>
</div>

<!-- DEBIT -->
<div class="card">
  <h3>Deduct Money</h3>
  <input id="debitUser" placeholder="Username or Account #">
  <input id="debitAmount" placeholder="Amount">
  <input id="debitDate" placeholder="Date (optional)">
  <button onclick="deductMoney()">Debit</button>
</div>

<!-- TRANSFER -->
<div class="card">
  <h3>Transfer</h3>
  <input id="fromAcc" placeholder="From Username/Acc #">
  <input id="toAcc" placeholder="To Username/Acc #">
  <input id="transferAmount" placeholder="Amount">
  <input id="transferDate" placeholder="Date (optional)">
  <button onclick="transferMoney()">Transfer</button>
</div>

<!-- SEARCH -->
<div class="card">
  <h3>Search Transaction</h3>
  <input id="searchRef" placeholder="Reference Number">
  <button onclick="searchTransaction()">Search</button>
  <div id="searchResult" class="result"></div>
</div>

<div class="msg" id="msg"></div>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBDp6wmJMY8WPyKPNE-bvVSiz4AIUbn71U",
  authDomain: "dechase-bank.firebaseapp.com",
  projectId: "dechase-bank"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* HELPERS */
function generateAccount(){
  return "DCB-" + Math.floor(1000000 + Math.random()*9000000);
}
function generateRef(){
  return "TX-" + Math.floor(10000000 + Math.random()*90000000);
}
async function findUser(input){
  const doc = await db.collection("users").doc(input).get();
  if(doc.exists) return doc;
  const snap = await db.collection("users")
    .where("accountNumber","==",input).get();
  if(!snap.empty) return snap.docs[0];
  return null;
}

/* ADMIN LOGIN */
async function adminLogin(){
  const user = adminUser.value.trim().toLowerCase();
  const pin = adminPin.value.trim();

  const doc = await db.collection("users").doc(user).get();

  if(!doc.exists || doc.data().pin !== pin || doc.data().role !== "admin"){
    alert("Invalid admin login");
    return;
  }

  loginCard.style.display="none";
  panel.style.display="block";
}

/* CREATE USER */
async function createUser(){
  const username = newUser.value.trim().toLowerCase();
  const pin = newPin.value.trim();
  const balance = Number(newBalance.value)||0;

  if(!username || !pin) return alert("Enter details");

  const exists = await db.collection("users").doc(username).get();
  if(exists.exists) return alert("User exists");

  const acc = generateAccount();

  await db.collection("users").doc(username).set({
    username,
    pin,
    balance,
    role:"user",
    accountNumber:acc,
    transactions:[]
  });

  msg.innerHTML = `âœ… User created<br>Account #: <b>${acc}</b>`;
}

/* CREDIT */
async function addMoney(){
  const user = creditUser.value.trim();
  const amount = Number(creditAmount.value);
  if(amount <= 0) return alert("Enter valid amount");

  const date = creditDate.value || new Date().toLocaleString();
  const doc = await findUser(user);
  if(!doc) return alert("User not found");

  const txRef = generateRef();

  await doc.ref.update({
    balance:(doc.data().balance||0)+amount,
    transactions:firebase.firestore.FieldValue.arrayUnion({
      amount,
      note:"Admin credit",
      ref:txRef,
      date:date
    })
  });

  msg.innerText="âœ… Credited | Ref: "+txRef;
}

/* DEBIT */
async function deductMoney(){
  const user = debitUser.value.trim();
  const amount = Number(debitAmount.value);
  if(amount <= 0) return alert("Enter valid amount");

  const date = debitDate.value || new Date().toLocaleString();
  const doc = await findUser(user);
  if(!doc) return alert("User not found");

  if(doc.data().balance < amount) return alert("Insufficient funds");

  const txRef = generateRef();

  await doc.ref.update({
    balance:doc.data().balance - amount,
    transactions:firebase.firestore.FieldValue.arrayUnion({
      amount:-amount,
      note:"Admin debit",
      ref:txRef,
      date:date
    })
  });

  msg.innerText="âœ… Debited | Ref: "+txRef;
}

/* SAFE TRANSFER */
async function transferMoney(){

  const from = fromAcc.value.trim();
  const to = toAcc.value.trim();
  const amount = Number(transferAmount.value);
  if(amount <= 0) return alert("Enter valid amount");
  if(from === to) return alert("Cannot transfer to same account");

  const date = transferDate.value || new Date().toLocaleString();

  const fromDoc = await findUser(from);
  const toDoc = await findUser(to);

  if(!fromDoc || !toDoc) return alert("User not found");

  const refNum = generateRef();

  await db.runTransaction(async (t)=>{

    const freshFrom = await t.get(fromDoc.ref);
    const freshTo   = await t.get(toDoc.ref);

    if(freshFrom.data().balance < amount)
      throw "Insufficient funds";

    t.update(fromDoc.ref,{
      balance: freshFrom.data().balance - amount,
      transactions: firebase.firestore.FieldValue.arrayUnion({
        amount:-amount,
        note:"Transfer to "+freshTo.data().username,
        ref:refNum,
        date:date
      })
    });

    t.update(toDoc.ref,{
      balance: freshTo.data().balance + amount,
      transactions: firebase.firestore.FieldValue.arrayUnion({
        amount:amount,
        note:"Transfer from "+freshFrom.data().username,
        ref:refNum,
        date:date
      })
    });

  });

  msg.innerText="âœ… Transfer complete | Ref: "+refNum;
}

/* SEARCH */
async function searchTransaction(){
  const ref = searchRef.value.trim();
  searchResult.innerHTML="Searching...";
  const snap = await db.collection("users").get();
  let found=false;

  snap.forEach(doc=>{
    const txs = doc.data().transactions||[];
    txs.forEach(tx=>{
      if(tx.ref===ref){
        found=true;
        searchResult.innerHTML =
          `<b>User:</b> ${doc.data().username}<br>
           <b>Amount:</b> ${tx.amount}<br>
           <b>Note:</b> ${tx.note}<br>
           <b>Date:</b> ${tx.date}`;
      }
    });
  });

  if(!found) searchResult.innerHTML="No transaction found";
}
</script>
</body>
</html>