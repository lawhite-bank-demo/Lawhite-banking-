<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Panel</title>

<style>
body{
  font-family: Arial;
  background:#0b1e35;
  color:white;
  text-align:center;
}
.card{
  background:#102a46;
  padding:20px;
  border-radius:12px;
  margin:20px;
}
input,button,select{
  width:90%;
  padding:12px;
  margin-top:10px;
  border-radius:8px;
  border:none;
}
button{
  background:#2ecc71;
  color:white;
  font-size:16px;
}
.msg{
  margin-top:10px;
  color:#2ecc71;
}
.result{
  margin-top:10px;
  background:#0b1e35;
  padding:10px;
  border-radius:8px;
}
</style>
</head>
<body>

<h2>Admin Panel</h2>

<!-- CREATE USER -->
<div class="card">
  <h3>Create User</h3>
  <input id="newUser" placeholder="Username">
  <input id="newPin" placeholder="PIN">
  <input id="newBalance" placeholder="Starting Balance">
  <select id="newCurrency">
    <option value="EUR">EUR</option>
    <option value="USD">USD</option>
    <option value="GBP">GBP</option>
  </select>
  <button onclick="createUser()">Create User</button>
</div>

<!-- CREDIT -->
<div class="card">
  <h3>Credit Account</h3>
  <input id="targetUser" placeholder="Username">
  <input id="amount" placeholder="Amount">
  <button onclick="addMoney()">Add Money</button>
</div>

<!-- DEBIT -->
<div class="card">
  <h3>Debit Account</h3>
  <input id="deductUser" placeholder="Username">
  <input id="deductAmount" placeholder="Amount">
  <button onclick="deductMoney()">Deduct Money</button>
</div>

<!-- TRANSFER -->
<div class="card">
  <h3>Transfer Using Account Number</h3>
  <input id="fromUser" placeholder="From Account Number">
  <input id="toUser" placeholder="To Account Number">
  <input id="transferAmount" placeholder="Amount">
  <button onclick="transferMoney()">Transfer</button>
</div>

<!-- SEARCH -->
<div class="card">
  <h3>Search Transaction</h3>
  <input id="searchRef" placeholder="Reference Number">
  <button onclick="searchTransaction()">Search</button>
  <div id="searchResult" class="result"></div>
</div>

<div class="msg" id="msg"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBDp6wmJMY8WPyKPNE-bvVSiz4AIUbn71U",
  authDomain: "dechase-bank.firebaseapp.com",
  projectId: "dechase-bank",
  storageBucket: "dechase-bank.appspot.com",
  messagingSenderId: "44428081485",
  appId: "1:44428081485:web:85d993a939d380336e1f04"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function generateRef(){
  return "DCB-" + Math.floor(10000000 + Math.random()*90000000);
}

function generateAccount(){
  return "DCB-" + Math.floor(10000000 + Math.random()*90000000);
}

// CREATE USER
function createUser(){
  const username = newUser.value.trim();
  const pin = newPin.value.trim();
  const balance = Number(newBalance.value) || 0;
  const currency = newCurrency.value;

  if(!username || !pin){
    alert("Enter username & PIN");
    return;
  }

  db.collection("users").doc(username).set({
    username,
    pin,
    balance,
    currency,
    role: "user",
    accountNumber: generateAccount(),
    transactions: []
  });

  msg.innerText = "✅ User created";
}

// CREDIT
function addMoney(){
  const username = targetUser.value.trim();
  const amount = Number(amount.value);

  const ref = db.collection("users").doc(username);

  db.runTransaction(async (t)=>{
    const doc = await t.get(ref);
    if(!doc.exists){ alert("User not found"); return; }

    const newBal = (doc.data().balance||0)+amount;

    t.update(ref,{
      balance:newBal,
      transactions:firebase.firestore.FieldValue.arrayUnion({
        amount,
        note:"Admin credit",
        ref:generateRef(),
        date:new Date().toLocaleString()
      })
    });
  });

  msg.innerText="✅ Money added";
}

// DEBIT
function deductMoney(){
  const username = deductUser.value.trim();
  const amount = Number(deductAmount.value);

  const ref = db.collection("users").doc(username);

  db.runTransaction(async (t)=>{
    const doc = await t.get(ref);
    if(!doc.exists){ alert("User not found"); return; }

    const bal = doc.data().balance||0;
    if(bal < amount){ alert("Insufficient funds"); return; }

    t.update(ref,{
      balance:bal-amount,
      transactions:firebase.firestore.FieldValue.arrayUnion({
        amount:-amount,
        note:"Admin debit",
        ref:generateRef(),
        date:new Date().toLocaleString()
      })
    });
  });

  msg.innerText="✅ Money deducted";
}

// TRANSFER USING ACCOUNT NUMBER
async function transferMoney(){

  const fromAcc = fromUser.value.trim();
  const toAcc = toUser.value.trim();
  const amount = Number(transferAmount.value);

  if(!fromAcc || !toAcc || !amount){
    alert("Enter details");
    return;
  }

  const users = db.collection("users");

  const fromQuery = await users.where("accountNumber","==",fromAcc).get();
  const toQuery = await users.where("accountNumber","==",toAcc).get();

  if(fromQuery.empty || toQuery.empty){
    alert("Account not found");
    return;
  }

  const fromDoc = fromQuery.docs[0];
  const toDoc = toQuery.docs[0];

  const refNum = generateRef();

  await db.runTransaction(async (t)=>{

    const fromBal = fromDoc.data().balance||0;
    if(fromBal < amount){ alert("Insufficient funds"); return; }

    const toBal = toDoc.data().balance||0;

    t.update(fromDoc.ref,{
      balance:fromBal-amount,
      transactions:firebase.firestore.FieldValue.arrayUnion({
        amount:-amount,
        note:"Transfer to "+toAcc,
        ref:refNum,
        date:new Date().toLocaleString()
      })
    });

    t.update(toDoc.ref,{
      balance:toBal+amount,
      transactions:firebase.firestore.FieldValue.arrayUnion({
        amount:amount,
        note:"Transfer from "+fromAcc,
        ref:refNum,
        date:new Date().toLocaleString()
      })
    });

  });

  msg.innerText="✅ Transfer complete";
}

// SEARCH TRANSACTION
async function searchTransaction(){
  const ref = searchRef.value.trim();
  searchResult.innerHTML="Searching...";

  const snapshot = await db.collection("users").get();
  let found=false;

  snapshot.forEach(doc=>{
    const data=doc.data();
    (data.transactions||[]).forEach(tx=>{
      if(tx.ref===ref){
        found=true;
        searchResult.innerHTML=
        `<b>User:</b> ${data.username}<br>
         <b>Amount:</b> ${tx.amount}<br>
         <b>Note:</b> ${tx.note}<br>
         <b>Date:</b> ${tx.date}`;
      }
    });
  });

  if(!found) searchResult.innerHTML="No transaction found";
}
</script>

</body>
</html>