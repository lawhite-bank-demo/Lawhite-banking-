<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DeChase Bank</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:linear-gradient(160deg,#020617,#031427,#021a35);
  color:white;
}
.container{max-width:420px;margin:auto;padding:20px;}

.card{
  background:rgba(255,255,255,0.05);
  backdrop-filter:blur(18px);
  border-radius:18px;
  padding:16px;
  margin-bottom:15px;
}

.balance-card{
  background:linear-gradient(135deg,#3aa0ff,#6ed0ff);
  border-radius:20px;
  padding:22px;
  text-align:center;
}

.balance{font-size:34px;font-weight:700;}
.eye{margin-top:6px;font-size:14px;cursor:pointer;}

input, textarea, select{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:10px;
  border:none;
  font-size:15px;
}

button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:10px;
  background:#2d8cff;
  color:white;
  font-weight:600;
}

.small{font-size:12px;opacity:.7;}
.reply{color:#6ed0ff;margin-top:4px;}
.success{color:#00ffb2;}
.error{color:#ff6b6b;}
</style>
</head>
<body>

<div class="container">

<h3 id="welcome"></h3>

<div class="balance-card">
  <div class="balance" id="balance">‚Ç¨0</div>
  <div class="eye" id="eyeToggle" onclick="toggleBalance()">üëÅ Hide balance</div>
</div>

<div class="card">
<b>Account Info</b><br>
Name: <span id="name"></span><br>
Account: <span id="acc"></span><br>
IBAN: <span id="iban"></span>
</div>

<div class="card">
<b>Send Money</b>
<input id="receiver" placeholder="Username OR IBAN">
<input id="amount" type="number" placeholder="Amount">
<input id="desc" placeholder="Description">
<button onclick="askPin()">Send</button>
</div>

<div class="card">
<b>Support Center</b>

<select id="subject">
  <option>Account Issue</option>
  <option>Transfer Problem</option>
  <option>Card Help</option>
  <option>Other</option>
</select>

<textarea id="message" placeholder="Describe your issue"></textarea>
<button onclick="sendSupport()">Send Message</button>

<div id="supportHistory" class="small"></div>
</div>

<div class="card">
<b>Security ‚Äî Change PIN</b>

<input id="oldPin" type="password" placeholder="Current PIN">
<input id="newPin" type="password" placeholder="New PIN">
<input id="confirmPin" type="password" placeholder="Confirm New PIN">

<button onclick="changePin()">Update PIN</button>

<div id="pinMsg" class="small"></div>
</div>

<button onclick="logout()">Logout</button>

</div>

<!-- PIN MODAL -->
<div id="pinModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;">
  <div style="background:#0a223d;padding:25px;border-radius:15px;width:85%;max-width:320px;text-align:center;">
    <h3>Enter Transaction PIN</h3>
    <input id="pinInput" type="password" placeholder="PIN">
    <button onclick="confirmTransfer()">Confirm</button>
    <button onclick="closePin()" style="background:#555;margin-top:6px;">Cancel</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, collection,
  addDoc, getDocs, updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBDp6wmJMY8WPyKPNE-bvVSiz4AIUbn71U",
  authDomain: "dechase-bank.firebaseapp.com",
  projectId: "dechase-bank"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const username = localStorage.getItem("user");
if(!username) location.href="index.html";

const snap = await getDoc(doc(db,"users",username));
const data = snap.data() || {};

welcome.innerText="Hello, "+(data.fullName||"User");
name.innerText=data.fullName||"-";
acc.innerText=data.accountNumber||"-";
iban.innerText=data.iban||"-";

const balanceValue=Number(data.balance||0);

let hidden=false;
function renderBalance(){
 balance.innerText = hidden?"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢":"‚Ç¨"+balanceValue.toLocaleString();
 eyeToggle.innerText = hidden?"üëÅ Show balance":"üëÅ Hide balance";
}
window.toggleBalance=()=>{hidden=!hidden;renderBalance();};
renderBalance();

/* TRANSFER WITH PIN */
let transferData=null;

window.askPin=()=>{
 const receiverInput=receiver.value.trim();
 const amt=parseFloat(amount.value);
 const desc=document.getElementById("desc").value||"Transfer";
 if(!receiverInput||!amt) return alert("Fill all fields");
 transferData={receiverInput,amt,desc};
 pinModal.style.display="flex";
};

window.closePin=()=>{
 pinModal.style.display="none";
 pinInput.value="";
};

window.confirmTransfer=async()=>{
 if(pinInput.value !== data.pin) return alert("Incorrect PIN");
 closePin();

 const {receiverInput,amt,desc}=transferData;
 const users=await getDocs(collection(db,"users"));

 let receiverName=null, receiverData=null;
 users.forEach(d=>{
   const u=d.data();
   if(d.id===receiverInput || u.iban===receiverInput){
     receiverName=d.id; receiverData=u;
   }
 });

 if(!receiverName) return alert("Receiver not found");
 if(balanceValue<amt) return alert("Insufficient funds");

 const date=new Date().toLocaleString();
 const ref="DCB"+Math.floor(Math.random()*900000+100000);

 await updateDoc(doc(db,"users",username),{
  balance:balanceValue-amt,
  transactions:[...(data.transactions||[]),
   {amount:-amt,note:"Sent to "+receiverName+" ‚Ä¢ "+desc,date,ref}]
 });

 await updateDoc(doc(db,"users",receiverName),{
  balance:Number(receiverData.balance||0)+amt,
  transactions:[...(receiverData.transactions||[]),
   {amount:amt,note:"Received from "+username,date,ref}]
 });

 localStorage.setItem("receipt",JSON.stringify({
   amount: amt.toLocaleString(),
   receiver: receiverName,
   date,
   ref
 }));

 window.location.href="receipt.html";
};

/* SUPPORT */
window.sendSupport=async()=>{
 const msg=document.getElementById("message").value.trim();
 if(!msg) return alert("Enter message");

 await addDoc(collection(db,"support_messages"),{
   user:username,
   subject:subject.value,
   message:msg,
   status:"open",
   date:new Date().toLocaleString()
 });

 alert("Message sent");
 document.getElementById("message").value="";
 loadSupportHistory();
};

async function loadSupportHistory(){
 const snap=await getDocs(collection(db,"support_messages"));
 supportHistory.innerHTML="";
 snap.forEach(doc=>{
   const d=doc.data();
   if(d.user===username){
     supportHistory.innerHTML+=`
       <p>
       üì© <b>${d.subject}</b><br>
       ${d.date}<br>
       ${d.reply?`<div class="reply">Support: ${d.reply}</div>`:"‚è≥ Awaiting response"}
       </p>`;
   }
 });
}
loadSupportHistory();

/* CHANGE PIN */
window.changePin = async () => {

 const oldPin = oldPin.value;
 const newPin = newPin.value;
 const confirmPin = confirmPin.value;
 const msg = document.getElementById("pinMsg");

 msg.innerText="";

 if(oldPin !== data.pin){
   msg.innerText="Current PIN incorrect";
   msg.className="small error";
   return;
 }

 if(newPin.length < 4){
   msg.innerText="PIN must be at least 4 digits";
   msg.className="small error";
   return;
 }

 if(newPin !== confirmPin){
   msg.innerText="New PINs do not match";
   msg.className="small error";
   return;
 }

 await updateDoc(doc(db,"users",username),{ pin:newPin });

 msg.innerText="PIN updated successfully";
 msg.className="small success";

 document.getElementById("oldPin").value="";
 document.getElementById("newPin").value="";
 document.getElementById("confirmPin").value="";
};

window.logout=()=>{
 localStorage.removeItem("user");
 location.href="index.html";
};
</script>

</body>
</html>
