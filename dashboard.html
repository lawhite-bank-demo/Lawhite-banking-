<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DeChase Bank</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#031427;
  color:white;
}
.container{
  max-width:420px;
  margin:auto;
  padding:20px;
}
.card{
  background:#0a223d;
  padding:15px;
  border-radius:15px;
  margin-bottom:15px;
}
.balance{
  background:linear-gradient(135deg,#2d8cff,#66c2ff);
  padding:20px;
  border-radius:15px;
  font-size:28px;
  font-weight:bold;
  text-align:center;
}
input,select,button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:8px;
  border:none;
  font-size:16px;
}
button{
  background:#2d8cff;
  color:white;
  font-weight:bold;
}
.green{color:#00ff9d;}
.red{color:#ff5c5c;}
</style>
</head>
<body>

<div class="container">

<h2 id="welcome"></h2>

<div class="card">
<b>Account Information</b><br>
Name: <span id="name"></span><br>
Bank: DeChase Bank<br>
Account Number: <span id="acc"></span><br>
IBAN: <span id="iban"></span><br>
SWIFT: DEUTDEFF
</div>

<div class="balance" id="balance"></div>

<div class="card">
<b>Transfer Money</b>
<input id="receiver" placeholder="Username OR IBAN">
<input id="amount" type="number" placeholder="Amount">
<input id="desc" placeholder="Description">
<button onclick="transfer()">Send</button>
</div>

<div class="card">
<b>Transactions</b>
<div id="transactions"></div>
</div>

<button onclick="logout()" style="background:#ff4d4d;">Logout</button>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, updateDoc, collection, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR KEY",
  authDomain: "YOUR DOMAIN",
  projectId: "YOUR ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const username = localStorage.getItem("user");
if(!username) location.href="index.html";

const userRef = doc(db,"users",username);
const snap = await getDoc(userRef);
const data = snap.data();

document.getElementById("welcome").innerText = "Hello, " + (data.fullName || data.username);
document.getElementById("name").innerText = data.fullName || data.username;
document.getElementById("acc").innerText = data.accountNumber;
document.getElementById("iban").innerText = data.iban;
document.getElementById("balance").innerText = "€" + data.balance.toLocaleString();

loadTransactions(data);

function loadTransactions(data){
  const box = document.getElementById("transactions");
  box.innerHTML = "";

  if(!data.transactions || data.transactions.length === 0){
    box.innerHTML = "<p>No transactions yet</p>";
    return;
  }

  data.transactions.slice().reverse().forEach(tx => {

    const note = tx.note || tx.description || "Transfer";
    const amount = tx.amount || 0;
    const date = tx.date || "";
    const type = amount > 0 ? "green" : "red";
    const sign = amount > 0 ? "+" : "";

    box.innerHTML += `
      <p class="${type}">
        ${note} (€${Math.abs(amount).toLocaleString()})
        <br><small>${date}</small>
      </p>
    `;
  });
}

async function transfer(){
  const receiverInput = document.getElementById("receiver").value.trim();
  const amount = parseFloat(document.getElementById("amount").value);
  const desc = document.getElementById("desc").value.trim() || "Transfer";

  if(!receiverInput || !amount) return alert("Fill all fields");

  let receiverName = null;
  let receiverData = null;

  const users = await getDocs(collection(db,"users"));

  users.forEach(docSnap=>{
    const u = docSnap.data();
    if(docSnap.id === receiverInput || u.iban === receiverInput){
      receiverName = docSnap.id;
      receiverData = u;
    }
  });

  if(!receiverName) return alert("Receiver not found");

  if(data.balance < amount) return alert("Insufficient funds");

  const newSenderBalance = data.balance - amount;
  const newReceiverBalance = receiverData.balance + amount;

  const date = new Date().toLocaleString();

  const senderTx = {
    amount: -amount,
    note: "Sent to " + receiverName + " • " + desc,
    date: date
  };

  const receiverTx = {
    amount: amount,
    note: "Received from " + username,
    date: date
  };

  await updateDoc(userRef,{
    balance:newSenderBalance,
    transactions:[...(data.transactions || []), senderTx]
  });

  await updateDoc(doc(db,"users",receiverName),{
    balance:newReceiverBalance,
    transactions:[...(receiverData.transactions || []), receiverTx]
  });

  alert("Transfer Successful");
  location.reload();
}

function logout(){
  localStorage.removeItem("user");
  location.href="index.html";
}
</script>

</body>
</html>
