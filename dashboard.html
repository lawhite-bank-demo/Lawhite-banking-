<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DeChase Finance</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Poppins', sans-serif;
  background:linear-gradient(180deg,#031427,#071f3a);
  color:white;
}
.container{max-width:420px;margin:auto;padding:20px;}
.header{display:flex;justify-content:space-between;align-items:center;}
.balanceCard{
  margin-top:20px;padding:25px;border-radius:20px;
  background:linear-gradient(135deg,#1e88e5,#42a5f5);
}
.balanceRow{display:flex;justify-content:space-between;align-items:center;}
.balance{font-size:36px;font-weight:600;}
.eye{cursor:pointer;}
.card{
  background:rgba(255,255,255,0.05);
  border-radius:18px;padding:18px;margin-top:20px;
}
button{
  width:100%;padding:14px;border:none;border-radius:12px;
  margin-top:10px;font-size:15px;background:#1e88e5;color:white;
}
input{width:100%;padding:12px;margin-top:8px;border:none;border-radius:10px;}
.tx{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.06);}
.amountPlus{color:#00e676;}
.amountMinus{color:#ff5252;}
.logout{background:#ff5252;margin-top:20px;}
small{opacity:.6;display:block;margin-top:3px;}
</style>
</head>
<body>

<div class="container">

<div class="header">
  <h2 id="welcome">Hello</h2>
</div>

<div class="balanceCard">
  <small>Available Balance</small>
  <div class="balanceRow">
    <div class="balance" id="balance">‚Ç¨0</div>
    <div class="eye" onclick="toggleBalance()">üëÅ</div>
  </div>
</div>

<div class="card">
  <strong>üí∏ Send Money</strong>
  <input id="receiver" placeholder="Username">
  <input id="amount" type="number" placeholder="Amount">
  <input id="desc" placeholder="Description (optional)">
  <button onclick="sendMoney()">Send</button>
</div>

<div class="card">
  <strong>üìú Transactions</strong>
  <div id="transactions"></div>
</div>

<button class="logout" onclick="logout()">Logout</button>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBDp6wmJMY8WPyKPNE-bvVSiz4AIUbn71U",
  authDomain: "dechase-bank.firebaseapp.com",
  projectId: "dechase-bank"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let username = localStorage.getItem("loggedInUser");
if(!username) location.href="login.html";
username = username.toLowerCase();

let balanceVisible=true;
let realBalance=0;

function toggleBalance(){
 balanceVisible=!balanceVisible;
 renderBalance();
}

function renderBalance(){
 document.getElementById("balance").innerText =
 balanceVisible ? "‚Ç¨"+realBalance.toLocaleString() : "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
}

function addTransaction(note, amount){
 return {
   amount:Number(amount),
   note,
   date:new Date().toLocaleString()
 };
}

// LIVE USER DATA
db.collection("users").doc(username)
.onSnapshot(doc=>{
 if(!doc.exists) return;

 const user=doc.data();
 document.getElementById("welcome").innerText="Hello, "+(user.username||username);

 realBalance=Number(user.balance)||0;
 renderBalance();

 const container=document.getElementById("transactions");
 container.innerHTML="";

 (user.transactions||[]).slice().reverse().slice(0,5).forEach(tx=>{
   const cls=tx.amount<0?"amountMinus":"amountPlus";
   container.innerHTML+=`
   <div class="tx">
     <div>${tx.note}<small>${tx.date}</small></div>
     <div class="${cls}">‚Ç¨${Math.abs(tx.amount)}</div>
   </div>`;
 });
});

// ‚úÖ FIXED SEND FUNCTION
async function sendMoney(){

 const to = document.getElementById("receiver").value.trim().toLowerCase();
 const amt = Number(document.getElementById("amount").value);
 const desc = document.getElementById("desc").value || "";

 if(!to || amt <= 0){
   alert("Enter valid details");
   return;
 }

 if(to === username){
   alert("Cannot send to yourself");
   return;
 }

 const fromRef = db.collection("users").doc(username);
 const toRef   = db.collection("users").doc(to);

 try{
 await db.runTransaction(async (t)=>{

   const fromDoc = await t.get(fromRef);
   const toDoc   = await t.get(toRef);

   if(!toDoc.exists) throw "Receiver not found";

   const senderBal = Number(fromDoc.data().balance) || 0;
   const recvBal   = Number(toDoc.data().balance) || 0;

   if(senderBal < amt) throw "Insufficient balance";

   t.update(fromRef,{
     balance: senderBal - amt,
     transactions: firebase.firestore.FieldValue.arrayUnion(
       addTransaction(`Sent to ${to} ‚Ä¢ ${desc}`, -amt)
     )
   });

   t.update(toRef,{
     balance: recvBal + amt,
     transactions: firebase.firestore.FieldValue.arrayUnion(
       addTransaction(`Received from ${username}`, amt)
     )
   });

 });

 alert("Transfer successful ‚úÖ");

 document.getElementById("receiver").value="";
 document.getElementById("amount").value="";
 document.getElementById("desc").value="";

 }catch(err){
   console.error(err);
   alert(err);
 }
}

function logout(){
 localStorage.removeItem("loggedInUser");
 location.href="login.html";
}
</script>
</body>
</html>