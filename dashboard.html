<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DeChase Bank</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#031427;
  color:white;
}
.container{max-width:420px;margin:auto;padding:20px;}
.card{
  background:#0a223d;
  padding:15px;
  border-radius:15px;
  margin-bottom:15px;
}
.balance{
  background:linear-gradient(135deg,#2d8cff,#66c2ff);
  padding:20px;
  border-radius:15px;
  font-size:28px;
  font-weight:bold;
  text-align:center;
}
input,button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:8px;
  border:none;
  font-size:16px;
}
button{background:#2d8cff;color:white;font-weight:bold;}
.green{color:#00ff9d;}
.red{color:#ff5c5c;}
</style>
</head>
<body>

<div class="container">

<h2 id="welcome"></h2>

<div class="card">
<b>Account Information</b><br>
Name: <span id="name"></span><br>
Account Number: <span id="acc"></span><br>
IBAN: <span id="iban"></span><br>
SWIFT: <span id="swift"></span>
</div>

<div class="balance" id="balance"></div>

<div class="card">
<b>Send Money</b>
<input id="receiver" placeholder="Username OR IBAN">
<input id="amount" type="number" placeholder="Amount">
<button onclick="transfer()">Send</button>
</div>

<div class="card">
<b>Transactions</b>
<div id="transactions"></div>
</div>

<button onclick="logout()" style="background:#ff4d4d;">Logout</button>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, updateDoc,
  collection, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
 apiKey:"AIzaSyBDp6wmJMY8WPyKPNE-bvVSiz4AIUbn71U",
 authDomain:"dechase-bank.firebaseapp.com",
 projectId:"dechase-bank"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const username = localStorage.getItem("user");
if(!username) location.href="index.html";

const userRef = doc(db,"users",username);
const snap = await getDoc(userRef);
const data = snap.data();
console.log(data);
alert(JSON.stringify(data));
/* DISPLAY INFO */
welcome.innerText = "Hello, " + data.fullName;
  name.innerText = data.fullName || "";
acc.innerText = data.accountNumber || "";
iban.innerText = data.iban || "";
swift.innerText = data.swift || "";
balance.innerText = "€" + Number(data.balance || 0).toLocaleString();

/* TRANSACTIONS */
if(data.transactions){
 data.transactions.slice().reverse().forEach(tx=>{
  const color = tx.amount > 0 ? "green":"red";
  transactions.innerHTML +=
  `<p class="${color}">
   ${tx.note} (€${Math.abs(tx.amount).toLocaleString()})
   <br><small>${tx.date}</small>
   </p>`;
 });
}

/* TRANSFER */
async function transfer(){
 const r = receiver.value.trim();
 const amt = parseFloat(amount.value);

 if(!r || !amt) return alert("Fill all fields");

 let receiverName=null, receiverData=null;

 const users = await getDocs(collection(db,"users"));

 users.forEach(d=>{
   const u=d.data();
   if(d.id===r || u.iban===r){
     receiverName=d.id;
     receiverData=u;
   }
 });

 if(!receiverName) return alert("Receiver not found");
 if(data.balance < amt) return alert("Insufficient funds");

 const date=new Date().toLocaleString();

 await updateDoc(userRef,{
  balance:data.balance-amt,
  transactions:[...(data.transactions||[]),
  {amount:-amt,note:"Sent to "+receiverName,date}]
 });

 await updateDoc(doc(db,"users",receiverName),{
  balance:receiverData.balance+amt,
  transactions:[...(receiverData.transactions||[]),
  {amount:amt,note:"Received from "+username,date}]
 });

 alert("Transfer successful");
 location.reload();
}

window.logout=()=>{
 localStorage.removeItem("user");
 location.href="index.html";
}
</script>
</body>
</html>
