<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, updateDoc, collection, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBDp6wmJMY8WPyKPNE-bvVSiz4AIUbn71U",
  authDomain: "dechase-bank.firebaseapp.com",
  projectId: "dechase-bank"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const username = localStorage.getItem("user");
if(!username) location.href="index.html";

const userRef = doc(db,"users",username);
const snap = await getDoc(userRef);
const data = snap.data() || {};

// âœ… SAFE DATA DISPLAY
document.getElementById("welcome").innerText =
  "Hello, " + (data.fullName || "User");

document.getElementById("name").innerText =
  data.fullName || "-";

document.getElementById("acc").innerText =
  data.accountNumber || "-";

document.getElementById("iban").innerText =
  data.iban || "-";

// add postcode if you want it visible later
const balanceValue = Number(data.balance || 0);

// ðŸ‘ balance toggle
let hidden=false;

function renderBalance(){
  document.getElementById("balance").innerText =
    hidden ? "â€¢â€¢â€¢â€¢â€¢â€¢" : "â‚¬" + balanceValue.toLocaleString();
}

window.toggleBalance = function(){
  hidden=!hidden;
  renderBalance();
};

renderBalance();

window.showTransfer = () =>{
  document.getElementById("transferBox").style.display="block";
};

window.payBills = () =>{
  alert("Bill payment feature ready");
};

window.buyGiftCard = () =>{
  alert("Gift card service ready");
};

loadTransactions(data);

function loadTransactions(data){
  const box=document.getElementById("transactions");
  box.innerHTML="";

  if(!data.transactions || data.transactions.length===0){
    box.innerHTML="<p class='small'>No transactions yet</p>";
    return;
  }

  data.transactions.slice().reverse().forEach(tx=>{
    const amount = Number(tx.amount || 0);
    const color = amount>0 ? "green" : "red";
    const note = tx.note || tx.description || "Transfer";

    box.innerHTML += `
      <p class="${color}">
        ${note}
        (â‚¬${Math.abs(amount).toLocaleString()})
        <br><span class="small">${tx.date || ""}</span>
      </p>
    `;
  });
}

window.transfer = async function(){
  const receiverInput = receiver.value.trim();
  const amt = parseFloat(document.getElementById("amount").value);
  const desc = document.getElementById("desc").value.trim() || "Transfer";

  if(!receiverInput || !amt) return alert("Fill all fields");

  const users = await getDocs(collection(db,"users"));
  let receiverName=null, receiverData=null;

  users.forEach(d=>{
    const u=d.data();
    if(d.id===receiverInput || u.iban===receiverInput){
      receiverName=d.id;
      receiverData=u;
    }
  });

  if(!receiverName) return alert("Receiver not found");
  if(balanceValue < amt) return alert("Insufficient funds");

  const date=new Date().toLocaleString();

  await updateDoc(userRef,{
    balance: balanceValue - amt,
    transactions:[...(data.transactions||[]),
      {amount:-amt,note:"Sent to "+receiverName+" â€¢ "+desc,date}]
  });

  await updateDoc(doc(db,"users",receiverName),{
    balance: Number(receiverData.balance||0) + amt,
    transactions:[...(receiverData.transactions||[]),
      {amount:amt,note:"Received from "+username,date}]
  });

  alert("Transfer Successful");
  location.reload();
};

window.logout = function(){
  localStorage.removeItem("user");
  location.href="index.html";
};
</script>