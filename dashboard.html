<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DeChase Bank</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:linear-gradient(160deg,#020617,#031427,#021a35);
  color:white;
}
.container{max-width:420px;margin:auto;padding:20px;}

.card{
  background:rgba(255,255,255,0.05);
  backdrop-filter:blur(18px);
  border-radius:18px;
  padding:16px;
  margin-bottom:15px;
  border:1px solid rgba(255,255,255,0.06);
}

.balance-card{
  background:linear-gradient(135deg,#3aa0ff,#6ed0ff);
  border-radius:20px;
  padding:22px;
  text-align:center;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}

.balance{font-size:34px;font-weight:700;}
.eye{margin-top:6px;font-size:14px;cursor:pointer;}

input,button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:10px;
  font-size:15px;
}

button{
  background:#2d8cff;
  color:white;
  font-weight:600;
}

.green{color:#00ffb2;}
.red{color:#ff6b6b;}
.frozen{color:#ffcc66;font-weight:600;}
.tx{margin-top:10px;}
.small{font-size:12px;opacity:.7;}
</style>
</head>
<body>

<div class="container">

<h3 id="welcome"></h3>

<div class="balance-card">
  <div class="balance" id="balance">‚Ç¨0</div>
  <div class="eye" id="toggleEye">üëÅ Hide balance</div>
</div>

<div class="card">
<b>Account Info</b><br>
Name: <span id="name"></span><br>
Account: <span id="acc"></span><br>
IBAN: <span id="iban"></span><br>
SWIFT: <span id="swift"></span>
<div id="frozenNotice" class="frozen"></div>
</div>

<div class="card">
<b>Send Money</b>
<input id="receiver" placeholder="Username OR IBAN">
<input id="amount" type="number" placeholder="Amount">
<button onclick="transfer()">Send</button>
</div>

<div class="card">
<b>Transactions</b>
<div id="transactions"></div>
</div>

<button onclick="logout()" style="background:#ff4d4d;">Logout</button>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, updateDoc,
  collection, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
 apiKey:"AIzaSyBDp6wmJMY8WPyKPNE-bvVSiz4AIUbn71U",
 authDomain:"dechase-bank.firebaseapp.com",
 projectId:"dechase-bank"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* SESSION */
const username = localStorage.getItem("user");
if(!username) location.href="index.html";

/* LOAD USER */
const userRef = doc(db,"users",username);
const snap = await getDoc(userRef);

if(!snap.exists()){
 alert("User data missing");
 location.href="index.html";
}

const data = snap.data();

/* DISPLAY INFO */
welcome.innerText = "Hello, " + (data.fullName || username);
name.innerText = data.fullName || "-";
acc.innerText = data.accountNumber || "-";
iban.innerText = data.iban || "-";
swift.innerText = data.swift || "-";

/* FROZEN NOTICE */
if(data.frozen){
 frozenNotice.innerText="‚ö† Account Frozen";
}

/* BALANCE WITH HIDE FEATURE */
let hidden=false;
const balanceValue = Number(data.balance || 0);

function renderBalance(){
 balance.innerText = hidden ? "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" : "‚Ç¨" + balanceValue.toLocaleString();
 toggleEye.innerText = hidden ? "üëÅ Show balance" : "üëÅ Hide balance";
}

toggleEye.onclick = ()=>{
 hidden = !hidden;
 renderBalance();
};

renderBalance();

/* TRANSACTIONS */
if(data.transactions){
 data.transactions.slice().reverse().forEach(tx=>{
  const amt = Number(tx.amount);
  const color = amt > 0 ? "green":"red";

  transactions.innerHTML += `
  <div class="tx ${color}">
    ${tx.note} (‚Ç¨${Math.abs(amt).toLocaleString()})
    <div class="small">${tx.date || ""}</div>
  </div>`;
 });
}

/* TRANSFER */
async function transfer(){

 if(data.frozen) return alert("Account frozen");

 const receiverInput = receiver.value.trim();
 const amt = parseFloat(amount.value);

 if(!receiverInput || !amt) return alert("Enter details");

 let receiverName=null;
 let receiverData=null;

 const users = await getDocs(collection(db,"users"));

 users.forEach(docSnap=>{
   const u = docSnap.data();
   if(docSnap.id === receiverInput || u.iban === receiverInput){
     receiverName = docSnap.id;
     receiverData = u;
   }
 });

 if(!receiverName) return alert("Receiver not found");
 if(balanceValue < amt) return alert("Insufficient funds");

 const date = new Date().toLocaleString();

 await updateDoc(userRef,{
   balance: balanceValue - amt,
   transactions:[...(data.transactions||[]),
   {amount:-amt, note:"Sent to "+receiverName, date}]
 });

 await updateDoc(doc(db,"users",receiverName),{
   balance:(receiverData.balance||0)+amt,
   transactions:[...(receiverData.transactions||[]),
   {amount:amt, note:"Received from "+username, date}]
 });

 alert("Transfer successful");
 location.reload();
}

/* LOGOUT */
window.logout=()=>{
 localStorage.removeItem("user");
 location.href="index.html";
}
</script>
</body>
</html>